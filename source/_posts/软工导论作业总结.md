---
title: è½¯å·¥å¯¼è®ºä½œä¸šæ€»ç»“
date: 2019-12-26 20:35:58
tags: arduino python
keywords: è½¯ä»¶å·¥ç¨‹å¯¼è®º ä½œä¸š æ€»ç»“
categories: æ€»ç»“
description:
summary_img:
---

åˆšåˆšå¿™å®Œäº†è®©æˆ‘å´©æºƒçš„è½¯å·¥å¯¼è®ºä½œä¸šï¼ŒæŠŠä¸€äº›æ ¸å¿ƒä»£ç å’Œæ€è·¯è´´ä¸Šæ¥ï¼Œå…ˆè®²ä¸€ä¸‹<del>ç¼ºç‚¹</del>feature

-   è ¢åˆ°çˆ†çš„é—¹é’Ÿé“ƒå£°ï¼ˆä¼°è®¡èƒ½æŠŠæˆ‘å«é†’ï¼‰
-   æ•ˆç‡æä½çš„è½®è¯¢æ›´æ–°çŠ¶æ€
-   æ¯«æ— å®‰å…¨æ€§å¯è¨€çš„ API æ¥å£
-   çœ‹èµ·æ¥æœ‰äº›ä¸åè°ƒçš„ç½‘é¡µ
-   æµ‹é‡æä¸º<del>ä¸</del>å‡†ç¡®çš„æ¸©æ¹¿åº¦è®¡

<!-- more -->

---

### Arduino éƒ¨åˆ†

`Alarm2.ino`

```cpp
#include <LiquidCrystal_I2C.h>
#include <dht11.h>
#include <ArduinoJson.h>

#define DPIN 4
#define BELLPIN 8

LiquidCrystal_I2C lcd(0x20, 16, 2);
int hum = 0, temp = 0;
// å‚¨å­˜æ ¼å¼: 0:å¹´ 1:æœˆ 2:æ—¥ 3:æ—¶ï¼ˆ24ï¼‰ 4ï¼šåˆ† 5ï¼šæ˜ŸæœŸ
int current_time[6] = {2019, 11, 21, 13, 58, 4};
int alarm_on = 0;
int alarm_time[5] = {0};
// x , y
int cursor_pos[2] = {3, 0};
String week[7] = {"SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"};
dht11 dht;
void ring()
{
  if (checkAlarm() == 1 && alarm_on)
  {
    // turn on the bell
    tone(BELLPIN, 700);
  }
  else
  {
    // turn off the bell
    noTone(BELLPIN);
  }
};

void formatOutput()
{
  lcd.setCursor(0, 0);
  if (checkAlarm() == 1 || checkAlarm() == 0)
  {
    lcd.print("A");
  }
  else
  {
    lcd.print(" ");
  }
  lcd.setCursor(3, 0);
  lcd.print(current_time[0]);
  lcd.print("/");
  if (current_time[1] < 10)
  {
    lcd.print("0");
  }
  lcd.print(current_time[1]);
  lcd.print("/");
  if (current_time[2] < 10)
  {
    lcd.print("0");
  }
  lcd.print(current_time[2]);
  lcd.setCursor(1, 1);
  if (current_time[3] < 10)
  {
    lcd.print("0");
  }
  lcd.print(current_time[3]);
  lcd.print(":");
  if (current_time[4] < 10)
  {
    lcd.print("0");
  }
  lcd.print(current_time[4]);
  lcd.print(" ");
  lcd.print(week[current_time[5]]);
  lcd.setCursor(12, 1);
  lcd.print(temp);
  lcd.print((char)223);
  lcd.print('C');
}

/*
    åŒæ­¥æ—¶é—´
*/
void asyncTime(StaticJsonDocument<200> doc)
{
  for (int i = 0; i < 6; i++)
  {
    current_time[i] = doc["data"][i];
  }
}
int checkAlarm()
{
  if (alarm_on == 0)
  {
    // æœªè®¾ç½®é—¹é’Ÿ
    return -1;
  }
  for (int i = 0; i < 5; i++)
  {
    if (current_time[i] < alarm_time[i])
    {
      // å½“å‰æ—¶é—´å°äºé—¹é’Ÿæ—¶é—´ï¼Œé—¹é’Ÿç­‰å¾…å¯åŠ¨
      return 0;
    }
    if (current_time[i] > alarm_time[i])
    {
      // å½“å‰æ—¶é—´å·²ç»å¤§äºé—¹é’Ÿæ—¶é—´ï¼Œé—¹é’Ÿå¤±æ•ˆ
      return 2;
    }
  }
  // å½“å‰æ—¶é—´ç­‰äºé—¹é’Ÿæ—¶é—´ é—¹é’Ÿå¯åŠ¨
  return 1;
}

void setAlarm(StaticJsonDocument<200> doc)
{
  // {"data": {"alarm_on": 1, "alarm_time": [2019, 12, 26, 10, 58]}, "type": "POST", "name": "set_alarm"}
  alarm_on = doc["data"]["alarm_on"];
  if (alarm_on)
  {
    for (int i = 0; i < 5; i++)
    {
      alarm_time[i] = doc["data"]["alarm_time"][i];
    }
  }
}
String rcvMsg()
{
  String rcvStr = "";
  if (!Serial.available())
  {
    return "NULL";
  }
  while (Serial.available())
  {
    char c = char(Serial.read());
    rcvStr += c;
    delay(2);
  }
  return rcvStr;
}
void retBasic()
{

  StaticJsonDocument<200> dat;
  dat["humidity"] = hum;
  dat["temperature"] = temp;
  serializeJson(dat, Serial);
}
void handleRequests(String req)
{

  StaticJsonDocument<200> doc;
  deserializeJson(doc, req.c_str());
  if (doc["type"] == "POST")
  {
    if (doc["name"] == "time")
    {
      asyncTime(doc);
      if (checkAlarm() == 1 || checkAlarm() == 0)
      {
        alarm_on = 1;
      }
      else
      {
        alarm_on = 0;
      }
    }
    else if (doc["name"] == "set_alarm")
    {
      // {"data": {"alarm_on": 1, "alarm_time": [2019, 12, 26, 10, 58]}, "type": "POST", "name": "set_alarm"}

      setAlarm(doc);
    }
  }
  else if (doc["type"] == "GET")
  {
    if (doc["name"] == "basic_info")
    {
      retBasic();
    }
  }
}

void getSensorDig()
{
  int chk = dht.read(DPIN);
  hum = dht.humidity;
  temp = dht.temperature;
}

void setup()
{
  Serial.begin(9600);
  pinMode(BELLPIN, OUTPUT);
  lcd.init();
  lcd.backlight();
}

void loop()
{

  for (int i = 0; i < 60 * 20; i++)
  {
    if (Serial.available())
    {
      handleRequests(Serial.readString());
    }
    if (i % 50 == 0)
    {
      getSensorDig();
    }
    ring();
    formatOutput();
    delay(20);
  }
}

```

-   ä½¿ç”¨ä¸²å£ä¸æ ‘è“æ´¾å–å¾—é€šä¿¡
-   è½®è¯¢é—¹é’ŸçŠ¶æ€
-   ä½¿ç”¨ JSON æ ¼å¼ä¼ é€’æ•°æ®
-   å†™çš„ä»£ç åˆä¸‘æ•ˆç‡åˆä½ TAT

---

### Raspberry Pi éƒ¨åˆ†

`test.py`

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-
from datetime import datetime

import serial
import time
import json
import requests

port = '/dev/ttyACM0'


class MySerial(serial.Serial):

    def reconnect(self):
        try:
            self.__init__(self)
            return True
        except OSError:
            return False

    # å‘arduinoå‘é€æ—¶é—´
    def send_json(self, dat):
        try:
            self.write(json.dumps(dat))
            return True
        except serial.serialutil.SerialException:
            return False

    def req(self, name, rq_type='POST', data=None):
        jd = {
            'type': rq_type,
            'name': name,
            'data': data
        }
        return self.send_json(jd)

    def read_json(self):
        d = self.readline()

        # print d
        try:
            jd = json.loads(d)
            return jd
        except ValueError:
            print 'JSON parse Error'
            return None


def gen_time_array():
    t = datetime.now().strftime('%Y-%m-%d-%H-%M-%w')
    arr = [0] * 7
    i = 0
    for it in t.split('-'):
        arr[i] = int(it)
        i += 1
    return arr


def alarm_available(alarm_time):
    current_time = gen_time_array()
    if len(alarm_time) < 5:
        return False
    for i in xrange(5):
        if current_time[i] > alarm_time[i]:
            return False
    return True


def safely_open():
    s = None
    while s is None:
        try:
            s = MySerial(port, 9600, timeout=2)
        except serial.serialutil.SerialException:
            s = None
            print 'No Connection, reconnect in 2 secs'
        time.sleep(2)
    return s


if __name__ == '__main__':
    # æ‰“å¼€ä¸arduinoçš„è¿æ¥
    ser = safely_open()
    print 'Connection established'
    time.sleep(5)
    while True:
        dic = {}
        ser.req('time', data=gen_time_array())
        ser.send_json(dic)
        time.sleep(2)
        ser.req('basic_info', rq_type='GET')
        data = ser.read_json()
        for i in xrange(10):
            response = requests.get('http://hyiker.com:27777/everything?password=123123')
            remote = json.loads(response.content)
            alarm = remote['alarm']
            if alarm['alarm_on'] == 1 and not alarm_available(alarm['alarm_time']):
                requests.post('http://hyiker.com:27777/alarm/cancel')
                print 'canceling'
            else:
                ser.req(name='set_alarm', data=remote['alarm'], rq_type='POST')
            time.sleep(2)
            ser.req('basic_info', rq_type='GET')
            time.sleep(1)
            requests.post('http://hyiker.com:27777/bi/set', json=ser.read_json())
            time.sleep(3)
            ser.req('time', data=gen_time_array())
            time.sleep(1)
```

-   ä½¿ç”¨ PythonSerial åº“æ¥è½®è¯¢ Arduino çš„çŠ¶æ€
-   ä½¿ç”¨ requests åº“ä¸Šä¼ ä¿¡æ¯ã€æ‹‰å–æœåŠ¡å™¨ä¿¡æ¯

---

### Server éƒ¨åˆ†

`main.py` <small>ï¼ˆåªè´´ python çš„ä¸€å°æ®µï¼‰</small>

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-
from flask import Flask, render_template, request
import json
import re

app = Flask(__name__)
storage = {"alarm": {"alarm_on": 0, "alarm_time": []},
           "basic_info": {"temperature": 12, "humidity": 75}}


def set_alarm(on=True, arr=None):
    if arr is None:
        arr = []
    if 'alarm' not in storage:
        storage['alarm'] = {}
    storage['alarm']['alarm_on'] = 1 if on else 0
    storage['alarm']['alarm_time'] = arr


@app.route('/bi/set', methods=['POST'])
def upload_bi():
    storage['basic_info'] = request.get_json()
    return ''


@app.route('/everything', methods=['GET'])
def get_everything():
    return json.dumps(storage)


@app.route('/')
def index():
    storage['basic_info'] = {
        "temperature": -1 if storage['basic_info'] is None else storage['basic_info']['temperature'],
        "humidity": -1 if storage['basic_info'] is None else storage['basic_info']['humidity']
    }

    return render_template('index.html', humidity=storage['basic_info']['humidity'],
                           temperature=storage['basic_info']['temperature'], alarm=storage['alarm'])


@app.route('/alarm/get')
def get_alarm():
    return storage['alarm']


@app.route('/alarm/set', methods=['POST'])
def upload_alarm():
    data = request.get_json()
    set_alarm(True, list(map(int, re.findall(r"[\d']+", data['t']))))
    return json.dumps({'msg': 'successfully set the alarm to %s' % data['t']})


@app.route('/alarm/cancel', methods=['POST'])
def cancel_alarm():
    set_alarm(on=False)
    return json.dumps({'msg': 'successfully cancel the alarm'})


if __name__ == '__main__':
    app.run(port=27777, host='127.0.0.1', debug=True)
```

-   ä½¿ç”¨ Flask åº“
-   æ— ä»»ä½•å®‰å…¨æ€§å¯è¨€

---

## å°å°çš„æ€»ç»“

æœ¬æ¬¡çš„ç”µå­é—¹é’Ÿåˆ¶ä½œå†æ¬¡<del>æ‘§æ®‹</del>æ¿€å‘äº†çš„åˆ›é€ åŠ›ï¼Œè®©æˆ‘äº†è§£äº† Serial ä¸²å£é€šä¿¡ç›¸å…³çš„çŸ¥è¯†ï¼Œç”±äº<del>æ‡’</del>æ—¶é—´æœ‰é™ï¼Œæ²¡æœ‰ç”¨ä¸Šè®¸å¤šæ–°å­¦çš„çŸ¥è¯†ã€‚

**æ—¥å¸¸æœŸæœ«ç¥ˆç¥· ğŸ™**
